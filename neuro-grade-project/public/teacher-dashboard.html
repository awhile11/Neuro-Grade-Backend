<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged,
    signOut 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    query, 
    where, 
    getDocs,
    doc,
    getDoc,
    orderBy,
    onSnapshot,
    setDoc,
    updateDoc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { 
    getStorage, 
    ref, 
    uploadBytes, 
    getDownloadURL 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB_jkCjYBpGzkwxtLmC6DKF7g0xxAAUPck",
    authDomain: "neuro-grade-aefa0.firebaseapp.com",
    projectId: "neuro-grade-aefa0",
    storageBucket: "neuro-grade-aefa0.firebasestorage.app",
    messagingSenderId: "301322876081",
    appId: "1:301322876081:web:c3fd4b8302da63462e5e90"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);
  
  console.log("Firebase initialized successfully");
  
  // Make Firebase objects globally available
  window.firebaseAuth = auth;
  window.firebaseDb = db;
  window.firebaseStorage = storage;
  window.firebaseFunctions = {
    onAuthStateChanged,
    signOut,
    collection,
    addDoc,
    query,
    where,
    getDocs,
    doc,
    getDoc,
    orderBy,
    onSnapshot,
    setDoc,
    updateDoc,
    deleteDoc,
    ref,
    uploadBytes,
    getDownloadURL
  };
</script>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  body {
    display: flex;
    background: #f8f9fa;
    height: 100vh;
    color: #333;
    overflow: hidden;
  }

  /* Loading screen */
  .loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #8e44ad;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    color: white;
  }

  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 20px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Top left logo */
  .top-left-logo {
    position: absolute;
    top: -35px;
    left: -10px;
    height: 200px;
    z-index: 1000;
  }

  /* Sidebar */
  .sidebar {
    width: 200px;
    height: 100vh;
    background: #fff;
    padding: 20px;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: center;
    box-shadow: 2px 0 8px rgba(0,0,0,0.08);
    border-radius: 0 12px 12px 0;
    transition: all 0.3s ease;
  }

  .nav {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
  }

  .nav a {
    text-decoration: none;
    width: 100%;
  }

  .nav button {
    background: none;
    border: 1px solid rgba(0,0,0,0.08);
    font-size: 16px;
    padding: 12px 15px;
    text-align: left;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s ease;
    color: #333;
    width: 100%;
    display: flex;
    align-items: center;
    gap: 15px;
    position: relative;
    overflow: hidden;
  }

  .nav button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(142, 68, 173, 0.1), transparent);
    transition: left 0.5s ease;
  }

  .nav button:hover::before {
    left: 100%;
  }

  .nav button.active {
    background: #8e44ad;
    color: #fff;
    font-weight: bold;
    border-color: #6c3483;
    transform: translateX(5px);
    box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
  }

  .nav button:hover {
    background: #f0e6f5;
    color: #8e44ad;
    border-color: #8e44ad;
    transform: translateX(3px);
  }

  .nav button i {
    transition: transform 0.3s ease;
  }

  .nav button:hover i {
    transform: scale(1.2);
  }

  .nav button.active i {
    transform: scale(1.2);
    color: #fff;
  }

  /* Main content */
  .main {
    flex: 1;
    padding: 20px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    margin-top: 70px;
    background: #f8f9fa;
    transition: all 0.3s ease;
  }

  /* Top bar */
  .top-bar {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.05);
  }

  .icon-link {
    position: relative;
    text-decoration: none;
    color: #8e44ad;
    font-size: 20px;
    transition: transform 0.3s, color 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #f0e6f5;
    margin-top: -10px;
    border: 1px solid rgba(142, 68, 173, 0.2);
  }

  .icon-link:hover {
    transform: scale(1.2) rotate(5deg);
    color: #ff6b6b;
    background: #ffe9e9;
    border-color: rgba(255, 107, 107, 0.3);
  }

  .icon-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff6b6b;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    border: 1px solid #fff;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  .top-user {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    padding: 8px 15px;
    background: #f8f9fa;
    border-radius: 20px;
    border: 1px solid rgba(0,0,0,0.08);
    transition: all 0.3s ease;
  }

  .top-user:hover {
    background: #f0e6f5;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .top-user img {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    object-fit: cover;
    transition: all 0.3s ease;
  }

  .top-user:hover img {
    transform: scale(1.1);
    border: 2px solid #8e44ad;
  }

  /* Welcome banner */
  .welcome-box {
    background: linear-gradient(to right, #8e44ad, #b57dff);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(142, 68, 173, 0.3);
    animation: fadeIn 0.5s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .welcome-box h1 {
    font-size: 24px;
    margin-bottom: 5px;
  }

  .welcome-box p {
    font-size: 14px;
    opacity: 0.9;
  }

  /* Dashboard layout */
  .dashboard {
    display: flex;
    gap: 20px;
    animation: fadeIn 0.7s ease;
  }

  /* Left column */
  .left-col {
    flex: 1;
  }

  .average-card {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.08);
    transition: all 0.3s ease;
  }

  .average-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }

  .average-card h2 {
    font-size: 16px;
    margin-bottom: 5px;
    color: #555;
  }

  .average-card .average {
    font-size: 32px;
    font-weight: bold;
    color: #8e44ad;
    margin: 10px 0;
    transition: all 0.3s ease;
  }

  .average-card .change {
    font-size: 14px;
    color: #28a745;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .average-card .students-count {
    font-size: 13px;
    color: #666;
    margin-top: 10px;
  }

  /* Subjects card */
  .subjects-card {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.08);
    transition: all 0.3s ease;
  }

  .subjects-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }

  .subjects-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }

  .subjects-header h2 {
    color: #333;
    margin: 0;
  }

  /* Subject item styles */
  .subject-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
  }

  .subject-item:hover {
    background: #f0e6f5;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .subject-info h3 {
    font-size: 16px;
    margin-bottom: 5px;
    color: #333;
  }

  .subject-info p {
    font-size: 13px;
    color: #666;
  }

  .subject-actions {
    display: flex;
    gap: 10px;
  }

  .material-btn {
    background: linear-gradient(135deg, #8e44ad, #b57dff);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    box-shadow: 0 2px 6px rgba(142, 68, 173, 0.3);
  }

  .material-btn:hover {
    background: linear-gradient(135deg, #793a9c, #9d6ad4);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(142, 68, 173, 0.4);
  }

  .material-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(142, 68, 173, 0.3);
  }

  .view-btn {
    background: linear-gradient(135deg, #3498db, #5dade2);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
  }

  .view-btn:hover {
    background: linear-gradient(135deg, #2980b9, #3498db);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
  }

  .view-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
  }

  .view-btn.active {
    background: linear-gradient(135deg, #1c5d99, #2980b9);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
  }

  /* Right column */
  .right-col {
    flex: 2;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.08);
    transition: all 0.3s ease;
  }

  .right-col:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }

  .right-col h2 {
    margin-bottom: 5px;
    color: #333;
  }

  .right-col > p {
    color: #666;
    margin-bottom: 20px;
    font-size: 14px;
  }

  .graph-container {
    min-height: 250px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px dashed #ddd;
    border-radius: 8px;
    background: #fafafa;
    color: #888;
    transition: all 0.3s ease;
    position: relative;
  }

  .graph-container:hover {
    border-color: #8e44ad;
    background: #f0e6f5;
  }

  /* Students list */
  .students-list {
    margin-top: 20px;
  }

  .student-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid #f5f5f5;
    transition: all 0.3s ease;
  }

  .student-item:hover {
    background: #f8f9fa;
    padding-left: 20px;
    border-radius: 6px;
  }

  .student-item:last-child {
    border-bottom: none;
  }

  .student-info h3 {
    font-size: 16px;
    margin-bottom: 5px;
    color: #333;
  }

  .student-info p {
    font-size: 13px;
    color: #666;
    margin-bottom: 0;
  }

  .student-actions {
    display: flex;
    gap: 10px;
  }

  .student-item button {
    background: #8e44ad;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .student-item button:hover {
    opacity: 0.9;
    transform: scale(1.05);
  }

  /* Popup styles */
  .popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.2);
    z-index: 1000;
    width: 500px;
    max-width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    border: 1px solid rgba(0,0,0,0.08);
    animation: popIn 0.3s ease;
  }

  @keyframes popIn {
    from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  }

  .popup h3 {
    margin-bottom: 15px;
    color: #8e44ad;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .popup-content {
    max-height: 60vh;
    overflow-y: auto;
    padding: 10px 0;
    color: #333;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
  }

  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: #8e44ad;
    box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.2);
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
  }

  .form-actions button {
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .btn-primary {
    background: #8e44ad;
    color: white;
    border: none;
  }

  .btn-primary:hover {
    background: #793a9c;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .btn-secondary {
    background: #6c757d;
    color: white;
    border: none;
  }

  .btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .popup-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #999;
    transition: all 0.3s ease;
  }

  .popup-close:hover {
    color: #ff6b6b;
    transform: rotate(90deg);
  }

  .overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    animation: fadeIn 0.3s ease;
  }

  /* Purple refresh button */
  .refresh-btn {
    background: #8e44ad;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    margin-top: 15px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    box-shadow: 0 2px 6px rgba(142, 68, 173, 0.3);
  }

  .refresh-btn:hover {
    background: #793a9c;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(142, 68, 173, 0.4);
  }

  .refresh-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(142, 68, 173, 0.3);
  }

  .refresh-btn:disabled {
    background: #b39ddb;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .empty-state {
    text-align: center;
    padding: 30px 0;
    color: #888;
    animation: fadeIn 0.5s ease;
  }

  .empty-state i {
    font-size: 40px;
    margin-bottom: 10px;
    color: #ddd;
  }

  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Status badges */
  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
  }
  
  .status-completed {
    background-color: #e8f5e9;
    color: #2e7d32;
  }
  
  .status-pending {
    background-color: #ffecb3;
    color: #f57c00;
  }
  
  .status-missing {
    background-color: #ffcdd2;
    color: #c62828;
  }

  /* Loading indicator */
  .loading-full {
    text-align: center;
    padding: 20px;
    color: #8e44ad;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
  }

  .loading-full i {
    font-size: 24px;
    margin-bottom: 10px;
    animation: spin 1s linear infinite;
  }

  /* Menu toggle for mobile (hidden by default) */
  .menu-toggle {
    display: none;
    position: fixed;
    top: 20px;
    right: 20px;
    background: #8e44ad;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 24px;
    cursor: pointer;
    z-index: 1001;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  .menu-toggle:hover {
    background: #793a9c;
    transform: rotate(90deg);
  }

  /* File upload styles */
  .file-input-container {
    position: relative;
    margin-bottom: 15px;
  }

  .file-input-label {
    display: block;
    padding: 10px;
    border: 2px dashed #8e44ad;
    border-radius: 6px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8f9fa;
  }

  .file-input-label:hover {
    background: #f0e6f5;
    border-color: #793a9c;
  }

  .file-input {
    display: none;
  }

  .file-name {
    margin-top: 5px;
    font-size: 12px;
    color: #666;
  }

  /* Message and notification styles */
  .message-item, .notification-item {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .message-item:hover, .notification-item:hover {
    background: #f8f9fa;
    padding-left: 20px;
    border-radius: 6px;
  }

  .message-item:last-child, .notification-item:last-child {
    border-bottom: none;
  }

  .message-header, .notification-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .message-sender, .notification-title {
    font-weight: 600;
    color: #333;
  }

  .message-time, .notification-time {
    font-size: 12px;
    color: #999;
  }

  .message-preview, .notification-preview {
    font-size: 13px;
    color: #666;
    line-height: 1.4;
  }

  .message-unread, .notification-unread {
    background-color: #e3f2fd;
    border-left: 4px solid #3498db;
  }

  .message-read, .notification-read {
    opacity: 0.8;
  }

  /* Logout button */
  .logout-btn {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    margin-top: 20px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    box-shadow: 0 2px 6px rgba(255, 107, 107, 0.3);
  }

  .logout-btn:hover {
    background: #ff5252;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(255, 107, 107, 0.4);
  }

  /* Subject view indicator */
  .subject-view-indicator {
    background: #e3f2fd;
    border-left: 4px solid #3498db;
    padding: 12px 15px;
    margin-bottom: 20px;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    animation: fadeIn 0.5s ease;
  }

  .subject-view-indicator h3 {
    color: #3498db;
    margin: 0;
    font-size: 16px;
  }

  .subject-view-indicator button {
    background: #3498db;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .subject-view-indicator button:hover {
    background: #2980b9;
    transform: translateY(-2px);
  }

  /* Message and notification popup styles */
  .message-details, .notification-details {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-top: 15px;
  }

  .message-actions, .notification-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
  }

  .mark-read-btn, .delete-btn {
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.3s ease;
  }

  .mark-read-btn {
    background: #3498db;
    color: white;
    border: none;
  }

  .mark-read-btn:hover {
    background: #2980b9;
  }

  .delete-btn {
    background: #e74c3c;
    color: white;
    border: none;
  }

  .delete-btn:hover {
    background: #c0392b;
  }

  /* Responsive design */
  @media (max-width: 992px) {
    .sidebar {
      position: fixed;
      left: -250px;
      height: 100%;
      z-index: 1000;
      margin-top: 0;
      border-radius: 0;
      transition: left 0.3s ease;
    }
    
    .sidebar.active {
      left: 0;
    }
    
    .main {
      margin-left: 0;
      margin-top: 20px;
    }
    
    .menu-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .dashboard {
      flex-direction: column;
    }
    
    .top-left-logo {
      top: 10px;
      left: 10px;
      height: 120px;
    }
    
    .subject-actions {
      flex-direction: column;
      width: 100%;
      gap: 5px;
    }
    
    .material-btn, .view-btn {
      width: 100%;
      justify-content: center;
    }
  }

  @media (max-width: 576px) {
    .top-bar {
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .top-user {
      order: -1;
      width: 100%;
      justify-content: center;
      margin-bottom: 10px;
    }
    
    .welcome-box h1 {
      font-size: 20px;
    }
    
    .popup {
      width: 95%;
      padding: 15px;
    }
    
    .subject-item {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    
    .subject-actions {
      flex-direction: row;
      width: 100%;
    }
  }
</style>
</head>
<body>
  <!-- Loading screen -->
  <div class="loading-screen" id="loading-screen">
    <div class="loading-spinner"></div>
    <h2>Loading Teacher Dashboard</h2>
    <p>Please wait while we load your data...</p>
  </div>

  <!-- Top left logo -->
  <img src="neuro grade logo.jpg" alt="NeuroGrade Logo" class="top-left-logo">

  <!-- Mobile menu toggle -->
  <button class="menu-toggle" id="menu-toggle">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="nav">
      <button class="active" data-page="home">
        <i class="fas fa-home"></i> Home
      </button>
      <button data-page="tasks" onclick="window.location.href='task.html'">
        <i class="fas fa-tasks"></i> Tasks
      </button>
      <button data-page="students" onclick="window.location.href='students.html'">
        <i class="fas fa-users"></i> Students
      </button>
      <button data-page="practice" onclick="window.location.href='practice.html'">
        <i class="fas fa-graduation-cap"></i> Practice
      </button>
      <button data-page="feedback" onclick="window.location.href='feedback.html'">
        <i class="fas fa-comment-dots"></i> Feedback
      </button>
    </div>
    <button class="logout-btn" id="logout-btn">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </div>

  <!-- Main -->
  <div class="main">
    <!-- Top bar -->
    <div class="top-bar">
      <a href="#" class="icon-link" id="mail-icon">
        <i class="fas fa-envelope"></i>
        <span class="icon-badge" id="mail-badge">0</span>
      </a>
      <a href="#" class="icon-link" id="notification-icon">
        <i class="fas fa-bell"></i>
        <span class="icon-badge" id="notification-badge">0</span>
      </a>
      <div class="top-user" id="user-info">
        <span><b id="user-name">Loading...</b><br><small id="user-email">Loading...</small></span>
        <img src="https://placehold.co/35x35/8e44ad/FFFFFF?text=?" alt="User" id="user-avatar">
      </div>
    </div>

    <!-- Subject View Indicator -->
    <div class="subject-view-indicator" id="subject-view-indicator" style="display: none;">
      <h3 id="current-subject-view">Currently viewing: <span id="subject-name"></span></h3>
      <button id="clear-subject-view">View All Subjects</button>
    </div>

    <!-- Welcome -->
    <div class="welcome-box">
      <h1 id="welcome-message">WELCOME BACK!</h1>
      <p>Here is a quick overview of your class and students progress</p>
    </div>

    <!-- Dashboard content -->
    <div class="dashboard">
      <!-- Left column -->
      <div class="left-col">
        <div class="average-card">
          <h2>Class Average Score</h2>
          <p class="average" id="class-average">--.--%</p>
          <p class="change" id="average-change">Loading data...</p>
          <p class="students-count" id="students-count">Loading students data...</p>
          <button class="refresh-btn" id="refresh-btn">
            <i class="fas fa-sync-alt"></i> Refresh Data
          </button>
        </div>

        <div class="subjects-card">
          <div class="subjects-header">
            <h2>Your Subjects</h2>
          </div>
          
          <div id="subjects-container">
            <div class="empty-state">
              <i class="fas fa-book-open"></i>
              <p>Loading subjects...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Right column -->
      <div class="right-col">
        <h2>Your Students</h2>
        <p>Students registered under your name</p>
        <div class="students-list" id="students-list">
          <div class="empty-state">
            <i class="fas fa-users" style="font-size: 50px; margin-bottom: 15px;"></i>
            <p>Loading students...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Material Popup -->
  <div class="popup" id="material-popup">
    <button class="popup-close">&times;</button>
    <h3><i class="fas fa-file-upload"></i> Add Study Material</h3>
    <div class="popup-content">
      <div class="form-group">
        <label for="material-title">Material Title</label>
        <input type="text" id="material-title" placeholder="Enter material title">
      </div>
      <div class="form-group">
        <label for="material-description">Description</label>
        <textarea id="material-description" placeholder="Enter material description" rows="3"></textarea>
      </div>
      <div class="form-group">
        <label>Upload File</label>
        <div class="file-input-container">
          <label for="material-file" class="file-input-label">
            <i class="fas fa-cloud-upload-alt"></i> Choose PDF, DOCX, or PPT file
          </label>
          <input type="file" id="material-file" class="file-input" accept=".pdf,.doc,.docx,.ppt,.pptx,.txt">
          <div class="file-name" id="file-name">No file chosen</div>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-secondary" id="cancel-material">Cancel</button>
        <button class="btn-primary" id="save-material">Upload</button>
      </div>
    </div>
  </div>

  <!-- Messages Popup -->
  <div class="popup" id="messages-popup">
    <button class="popup-close">&times;</button>
    <h3><i class="fas fa-envelope"></i> Your Messages</h3>
    <div class="popup-content" id="messages-content">
      <div class="empty-state">
        <i class="fas fa-envelope-open"></i>
        <p>No messages yet</p>
      </div>
    </div>
  </div>

  <!-- Notifications Popup -->
  <div class="popup" id="notifications-popup">
    <button class="popup-close">&times;</button>
    <h3><i class="fas fa-bell"></i> Notifications</h3>
    <div class="popup-content" id="notifications-content">
      <div class="empty-state">
        <i class="fas fa-bell-slash"></i>
        <p>No notifications yet</p>
      </div>
    </div>
  </div>

  <!-- Message Detail Popup -->
  <div class="popup" id="message-detail-popup">
    <button class="popup-close">&times;</button>
    <h3><i class="fas fa-envelope"></i> Message Details</h3>
    <div class="popup-content">
      <div id="message-detail-content">
        <div class="loading-full">
          <i class="fas fa-spinner"></i>
          <p>Loading message...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Detail Popup -->
  <div class="popup" id="notification-detail-popup">
    <button class="popup-close">&times;</button>
    <h3><i class="fas fa-bell"></i> Notification Details</h3>
    <div class="popup-content">
      <div id="notification-detail-content">
        <div class="loading-full">
          <i class="fas fa-spinner"></i>
          <p>Loading notification...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay"></div>

  <script>
    // DOM Elements
    const loadingScreen = document.getElementById('loading-screen');
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menu-toggle');
    const logoutBtn = document.getElementById('logout-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const subjectsContainer = document.getElementById('subjects-container');
    const studentsList = document.getElementById('students-list');
    const mailIcon = document.getElementById('mail-icon');
    const notificationIcon = document.getElementById('notification-icon');
    const materialPopup = document.getElementById('material-popup');
    const messagesPopup = document.getElementById('messages-popup');
    const notificationsPopup = document.getElementById('notifications-popup');
    const messageDetailPopup = document.getElementById('message-detail-popup');
    const notificationDetailPopup = document.getElementById('notification-detail-popup');
    const overlay = document.getElementById('overlay');
    const popupCloseButtons = document.querySelectorAll('.popup-close');
    const cancelMaterialBtn = document.getElementById('cancel-material');
    const saveMaterialBtn = document.getElementById('save-material');
    const materialTitleInput = document.getElementById('material-title');
    const materialDescriptionInput = document.getElementById('material-description');
    const materialFileInput = document.getElementById('material-file');
    const fileNameDisplay = document.getElementById('file-name');
    const welcomeMessage = document.getElementById('welcome-message');
    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    const userAvatar = document.getElementById('user-avatar');
    const classAverage = document.getElementById('class-average');
    const averageChange = document.getElementById('average-change');
    const studentsCount = document.getElementById('students-count');
    const mailBadge = document.getElementById('mail-badge');
    const notificationBadge = document.getElementById('notification-badge');
    const subjectViewIndicator = document.getElementById('subject-view-indicator');
    const subjectNameDisplay = document.getElementById('subject-name');
    const clearSubjectViewBtn = document.getElementById('clear-subject-view');
    const messagesContent = document.getElementById('messages-content');
    const notificationsContent = document.getElementById('notifications-content');
    const messageDetailContent = document.getElementById('message-detail-content');
    const notificationDetailContent = document.getElementById('notification-detail-content');

    // Global variables
    let currentUser = null;
    let currentTeacher = null;
    let teacherSubjects = [];
    let teacherStudents = [];
    let selectedSubjectForMaterial = null;
    let currentSubjectView = null;
    let messages = [];
    let notifications = [];

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function() {
      initializeAuth();
      setupEventListeners();
    });

    // Initialize Firebase authentication
    function initializeAuth() {
      window.firebaseFunctions.onAuthStateChanged(window.firebaseAuth, async (user) => {
        if (user) {
          currentUser = user;
          await loadTeacherData(user.uid);
          // Hide loading screen after data is loaded
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 1000);
        } else {
          // Redirect to login page if not authenticated
          window.location.href = 'index.html';
        }
      });
    }

    // Load teacher data from Firestore
    async function loadTeacherData(uid) {
      try {
        const teacherDoc = await window.firebaseFunctions.getDoc(
          window.firebaseFunctions.doc(window.firebaseDb, "teachers", uid)
        );
        
        if (teacherDoc.exists()) {
          currentTeacher = teacherDoc.data();
          updateUserInterface();
          await loadDashboardData();
        } else {
          console.error("Teacher data not found");
          // If teacher data doesn't exist, create it
          await createTeacherData(uid);
        }
      } catch (error) {
        console.error("Error loading teacher data:", error);
      }
    }

    // Create teacher data if it doesn't exist
    async function createTeacherData(uid) {
      try {
        const user = window.firebaseAuth.currentUser;
        if (!user) return;
        
        // Extract name from email as fallback
        const email = user.email;
        const nameParts = email.split('@')[0].split('.');
        const firstName = nameParts[0] ? nameParts[0].charAt(0).toUpperCase() + nameParts[0].slice(1) : 'Teacher';
        const lastName = nameParts[1] ? nameParts[1].charAt(0).toUpperCase() + nameParts[1].slice(1) : '';
        
        await window.firebaseFunctions.setDoc(
          window.firebaseFunctions.doc(window.firebaseDb, "teachers", uid),
          {
            uid: uid,
            firstName: firstName,
            lastName: lastName,
            email: email,
            createdAt: new Date()
          }
        );
        
        currentTeacher = {
          uid: uid,
          firstName: firstName,
          lastName: lastName,
          email: email
        };
        
        updateUserInterface();
        await loadDashboardData();
      } catch (error) {
        console.error("Error creating teacher data:", error);
      }
    }

    // Update UI with teacher data
    function updateUserInterface() {
      if (currentTeacher) {
        welcomeMessage.textContent = `WELCOME BACK, ${currentTeacher.firstName.toUpperCase()}!`;
        userName.textContent = `${currentTeacher.firstName} ${currentTeacher.lastName}`;
        userEmail.textContent = currentTeacher.email;
        userAvatar.src = `https://placehold.co/35x35/8e44ad/FFFFFF?text=${currentTeacher.firstName.charAt(0)}${currentTeacher.lastName.charAt(0)}`;
      }
    }

    // Load dashboard data
    async function loadDashboardData() {
      await loadTeacherSubjects();
      await loadStudents();
      await calculateClassAverage();
      await loadMessages();
      await loadNotifications();
    }

    // Load teacher's subjects from their registration data
    async function loadTeacherSubjects() {
      try {
        if (currentTeacher && currentTeacher.subjects) {
          teacherSubjects = currentTeacher.subjects;
          renderSubjects();
        } else {
          // If no subjects in teacher data, show empty state
          subjectsContainer.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-book-open"></i>
              <p>No subjects found</p>
              <p>Subjects from your registration will appear here</p>
            </div>
          `;
        }
      } catch (error) {
        console.error("Error loading teacher subjects:", error);
        subjectsContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Error loading subjects</p>
          </div>
        `;
      }
    }

    // Render subjects in the UI
    function renderSubjects() {
      if (teacherSubjects.length === 0) {
        subjectsContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-book-open"></i>
            <p>No subjects yet</p>
            <p>Subjects from your registration will appear here</p>
          </div>
        `;
        return;
      }
      
      subjectsContainer.innerHTML = '';
      
      teacherSubjects.forEach((subject, index) => {
        const subjectItem = document.createElement('div');
        subjectItem.className = 'subject-item';
        subjectItem.innerHTML = `
          <div class="subject-info">
            <h3>${subject}</h3>
            <p>Subject ${index + 1}</p>
          </div>
          <div class="subject-actions">
            <button class="view-btn ${currentSubjectView === subject ? 'active' : ''}" data-subject="${subject}">
              <i class="fas fa-eye"></i> View
            </button>
            <button class="material-btn" data-subject="${subject}">
              <i class="fas fa-file-upload"></i> Add Material
            </button>
          </div>
        `;
        subjectsContainer.appendChild(subjectItem);
      });
      
      // Add event listeners to material buttons
      const materialButtons = subjectsContainer.querySelectorAll('.material-btn');
      materialButtons.forEach(button => {
        button.addEventListener('click', function() {
          const subject = this.getAttribute('data-subject');
          openMaterialPopup(subject);
        });
      });
      
      // Add event listeners to view buttons
      const viewButtons = subjectsContainer.querySelectorAll('.view-btn');
      viewButtons.forEach(button => {
        button.addEventListener('click', function() {
          const subject = this.getAttribute('data-subject');
          setSubjectView(subject);
        });
      });
    }

    // Set the current subject view
    function setSubjectView(subject) {
      currentSubjectView = subject;
      subjectNameDisplay.textContent = subject;
      subjectViewIndicator.style.display = 'flex';
      
      // Update UI to reflect the active view button
      renderSubjects();
      renderStudents();
      calculateClassAverage();
    }

    // Clear the subject view
    function clearSubjectView() {
      currentSubjectView = null;
      subjectViewIndicator.style.display = 'none';
      
      // Update UI to reflect the change
      renderSubjects();
      renderStudents();
      calculateClassAverage();
    }

    // Load students registered under this teacher
    async function loadStudents() {
      try {
        if (!currentTeacher) return;
        
        const teacherFullName = `${currentTeacher.firstName} ${currentTeacher.lastName}`;
        
        const studentsQuery = window.firebaseFunctions.query(
          window.firebaseFunctions.collection(window.firebaseDb, "students"),
          window.firebaseFunctions.where("teacherName", "==", teacherFullName)
        );
        
        const querySnapshot = await window.firebaseFunctions.getDocs(studentsQuery);
        teacherStudents = [];
        
        querySnapshot.forEach((doc) => {
          teacherStudents.push({ id: doc.id, ...doc.data() });
        });
        
        renderStudents();
      } catch (error) {
        console.error("Error loading students:", error);
        studentsList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Error loading students</p>
          </div>
        `;
      }
    }

    // Render students in the UI
    function renderStudents() {
      // Filter students by current subject view if set
      let filteredStudents = teacherStudents;
      if (currentSubjectView) {
        filteredStudents = teacherStudents.filter(student => 
          student.subjects && student.subjects.includes(currentSubjectView)
        );
      }
      
      if (filteredStudents.length === 0) {
        studentsList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-users"></i>
            <p>${currentSubjectView ? `No students enrolled in ${currentSubjectView}` : 'No students yet'}</p>
            <p>${currentSubjectView ? 'Students who register for this subject will appear here' : 'Students who register under your name will appear here'}</p>
          </div>
        `;
        return;
      }
      
      studentsList.innerHTML = '';
      
      filteredStudents.forEach(student => {
        const studentItem = document.createElement('div');
        studentItem.className = 'student-item';
        
        // Get subjects for display (limited to 2 for brevity)
        const displaySubjects = student.subjects ? 
          (student.subjects.length > 2 ? 
            `${student.subjects.slice(0, 2).join(', ')}...` : 
            student.subjects.join(', ')) : 
          'No subjects';
        
        studentItem.innerHTML = `
          <div class="student-info">
            <h3>${student.firstName} ${student.lastName}</h3>
            <p>Student #: ${student.studentNumber} | Email: ${student.email}</p>
            <p>Subjects: ${displaySubjects}</p>
          </div>
          <div class="student-actions">
            <button class="view-student" data-id="${student.id}">
              <i class="fas fa-eye"></i> View
            </button>
          </div>
        `;
        studentsList.appendChild(studentItem);
      });
      
      // Update students count
      const totalStudents = teacherStudents.length;
      const filteredCount = filteredStudents.length;
      studentsCount.textContent = currentSubjectView 
        ? `Based on ${filteredCount} of ${totalStudents} students (${currentSubjectView})` 
        : `Based on ${totalStudents} students`;
    }

    // Calculate class average from real student data
    async function calculateClassAverage() {
      try {
        // Filter students by current subject view if set
        let filteredStudents = teacherStudents;
        if (currentSubjectView) {
          filteredStudents = teacherStudents.filter(student => 
            student.subjects && student.subjects.includes(currentSubjectView)
          );
        }
        
        const studentCount = filteredStudents.length;
        
        if (studentCount === 0) {
          classAverage.textContent = "0%";
          averageChange.textContent = "No data available";
          studentsCount.textContent = currentSubjectView 
            ? `No students enrolled in ${currentSubjectView}` 
            : "No students registered yet";
          return;
        }
        
        // Get all student grades from the database
        let totalScore = 0;
        let totalAssignments = 0;
        
        for (const student of filteredStudents) {
          // Query for student's grades
          const gradesQuery = window.firebaseFunctions.query(
            window.firebaseFunctions.collection(window.firebaseDb, "grades"),
            window.firebaseFunctions.where("studentId", "==", student.id)
          );
          
          const querySnapshot = await window.firebaseFunctions.getDocs(gradesQuery);
          
          querySnapshot.forEach((doc) => {
            const gradeData = doc.data();
            // If viewing a specific subject, only include grades for that subject
            if (gradeData.score && (!currentSubjectView || gradeData.subject === currentSubjectView)) {
              totalScore += gradeData.score;
              totalAssignments++;
            }
          });
        }
        
        // Calculate average
        if (totalAssignments > 0) {
          const average = (totalScore / totalAssignments).toFixed(1);
          classAverage.textContent = `${average}%`;
          averageChange.textContent = currentSubjectView 
            ? `Based on ${currentSubjectView} assignments` 
            : "Based on actual student performance";
          studentsCount.textContent = currentSubjectView 
            ? `Based on ${studentCount} students and ${totalAssignments} ${currentSubjectView} assignments` 
            : `Based on ${studentCount} students and ${totalAssignments} assignments`;
        } else {
          classAverage.textContent = "N/A";
          averageChange.textContent = "No grade data available";
          studentsCount.textContent = currentSubjectView 
            ? `Based on ${studentCount} students (no ${currentSubjectView} grades yet)` 
            : `Based on ${studentCount} students`;
        }
        
      } catch (error) {
        console.error("Error calculating class average:", error);
        classAverage.textContent = "Error";
        averageChange.textContent = "Unable to calculate";
      }
    }

    // Enhanced file type validation
    function validateFileType(file) {
      const allowedTypes = [
        'application/pdf',
        'application/x-pdf',
        'application/acrobat',
        'applications/vnd.pdf',
        'text/pdf',
        'text/x-pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-powerpoint',
        'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'text/plain'
      ];
      
      // Check file extensions as well
      const fileExtension = file.name.split('.').pop().toLowerCase();
      const allowedExtensions = ['pdf', 'doc', 'docx', 'ppt', 'pptx', 'txt'];
      
      const isAllowedByType = allowedTypes.includes(file.type);
      const isAllowedByExtension = allowedExtensions.includes(fileExtension);
      
      return isAllowedByType || isAllowedByExtension;
    }

    // Enhanced file upload function
    async function uploadStudyMaterial(file, metadata) {
      try {
        // Validate file type
        if (!validateFileType(file)) {
          throw new Error('Invalid file type. Please upload PDF, DOC, DOCX, PPT, or PPTX files only.');
        }
        
        // Validate file size (10MB limit)
        const maxSize = 10 * 1024 * 1024; // 10MB in bytes
        if (file.size > maxSize) {
          throw new Error('File size too large. Maximum size is 10MB.');
        }
        
        // Create a unique filename
        const timestamp = Date.now();
        const safeFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
        const uniqueFileName = `${timestamp}_${safeFileName}`;
        
        // Create storage reference
        const storageRef = window.firebaseFunctions.ref(
          window.firebaseStorage, 
          `studyMaterials/${currentUser.uid}/${uniqueFileName}`
        );
        
        // Upload file
        const snapshot = await window.firebaseFunctions.uploadBytes(storageRef, file);
        const downloadURL = await window.firebaseFunctions.getDownloadURL(snapshot.ref);
        
        // Save metadata to Firestore
        const materialData = {
          title: metadata.title,
          description: metadata.description,
          fileUrl: downloadURL,
          fileName: file.name,
          fileType: file.type,
          fileSize: file.size,
          subject: metadata.subject,
          teacherId: currentUser.uid,
          teacherName: `${currentTeacher.firstName} ${currentTeacher.lastName}`,
          uploadedAt: new Date(),
          status: 'active',
          lastUpdated: new Date()
        };
        
        // Save to studyMaterials collection with auto-generated ID
        const docRef = await window.firebaseFunctions.addDoc(
          window.firebaseFunctions.collection(window.firebaseDb, "studyMaterials"),
          materialData
        );
        
        console.log("Material saved with ID:", docRef.id);
        return { success: true, id: docRef.id };
        
      } catch (error) {
        console.error("Error uploading material:", error);
        throw error;
      }
    }

    // Load messages from Firestore
    async function loadMessages() {
      try {
        if (!currentUser) return;
        
        const messagesQuery = window.firebaseFunctions.query(
          window.firebaseFunctions.collection(window.firebaseDb, "messages"),
          window.firebaseFunctions.where("teacherId", "==", currentUser.uid),
          window.firebaseFunctions.orderBy("timestamp", "desc")
        );
        
        const querySnapshot = await window.firebaseFunctions.getDocs(messagesQuery);
        messages = [];
        
        querySnapshot.forEach((doc) => {
          messages.push({ id: doc.id, ...doc.data() });
        });
        
        // Update badge count (only unread messages)
        const unreadCount = messages.filter(msg => !msg.read).length;
        mailBadge.textContent = unreadCount > 0 ? unreadCount : 0;
        
        // Render messages in the popup
        renderMessages();
      } catch (error) {
        console.error("Error loading messages:", error);
      }
    }

    // Render messages in the popup
    function renderMessages() {
      if (messages.length === 0) {
        messagesContent.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-envelope-open"></i>
            <p>No messages yet</p>
          </div>
        `;
        return;
      }
      
      messagesContent.innerHTML = '';
      
      messages.forEach(message => {
        const messageItem = document.createElement('div');
        messageItem.className = `message-item ${message.read ? 'message-read' : 'message-unread'}`;
        messageItem.setAttribute('data-id', message.id);
        
        // Format date
        const messageDate = message.timestamp ? message.timestamp.toDate() : new Date();
        const formattedDate = messageDate.toLocaleDateString() + ' ' + messageDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Truncate message content for preview
        const previewContent = message.content ? 
          (message.content.length > 100 ? message.content.substring(0, 100) + '...' : message.content) : 
          'No content';
        
        messageItem.innerHTML = `
          <div class="message-header">
            <div class="message-sender">${message.senderName || 'Unknown Sender'}</div>
            <div class="message-time">${formattedDate}</div>
          </div>
          <div class="message-preview">
            <strong>${message.subject || 'No Subject'}</strong> - ${previewContent}
          </div>
        `;
        
        messagesContent.appendChild(messageItem);
      });
      
      // Add click event listeners to message items
      const messageItems = messagesContent.querySelectorAll('.message-item');
      messageItems.forEach(item => {
        item.addEventListener('click', function() {
          const messageId = this.getAttribute('data-id');
          openMessageDetail(messageId);
        });
      });
    }

    // Load notifications from Firestore
    async function loadNotifications() {
      try {
        if (!currentUser) return;
        
        const notificationsQuery = window.firebaseFunctions.query(
          window.firebaseFunctions.collection(window.firebaseDb, "notifications"),
          window.firebaseFunctions.where("teacherId", "==", currentUser.uid),
          window.firebaseFunctions.orderBy("timestamp", "desc")
        );
        
        const querySnapshot = await window.firebaseFunctions.getDocs(notificationsQuery);
        notifications = [];
        
        querySnapshot.forEach((doc) => {
          notifications.push({ id: doc.id, ...doc.data() });
        });
        
        // Update badge count (only unread notifications)
        const unreadCount = notifications.filter(notif => !notif.read).length;
        notificationBadge.textContent = unreadCount > 0 ? unreadCount : 0;
        
        // Render notifications in the popup
        renderNotifications();
      } catch (error) {
        console.error("Error loading notifications:", error);
      }
    }

    // Render notifications in the popup
    function renderNotifications() {
      if (notifications.length === 0) {
        notificationsContent.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-bell-slash"></i>
            <p>No notifications yet</p>
          </div>
        `;
        return;
      }
      
      notificationsContent.innerHTML = '';
      
      notifications.forEach(notification => {
        const notificationItem = document.createElement('div');
        notificationItem.className = `notification-item ${notification.read ? 'notification-read' : 'notification-unread'}`;
        notificationItem.setAttribute('data-id', notification.id);
        
        // Format date
        const notificationDate = notification.timestamp ? notification.timestamp.toDate() : new Date();
        const formattedDate = notificationDate.toLocaleDateString() + ' ' + notificationDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Truncate notification content for preview
        const previewContent = notification.message ? 
          (notification.message.length > 100 ? notification.message.substring(0, 100) + '...' : notification.message) : 
          'No content';
        
        notificationItem.innerHTML = `
          <div class="notification-header">
            <div class="notification-title">${notification.title || 'Notification'}</div>
            <div class="notification-time">${formattedDate}</div>
          </div>
          <div class="notification-preview">
            ${previewContent}
          </div>
        `;
        
        notificationsContent.appendChild(notificationItem);
      });
      
      // Add click event listeners to notification items
      const notificationItems = notificationsContent.querySelectorAll('.notification-item');
      notificationItems.forEach(item => {
        item.addEventListener('click', function() {
          const notificationId = this.getAttribute('data-id');
          openNotificationDetail(notificationId);
        });
      });
    }

    // Open message detail popup
    async function openMessageDetail(messageId) {
      const message = messages.find(msg => msg.id === messageId);
      
      if (!message) {
        alert('Message not found');
        return;
      }
      
      // Format date
      const messageDate = message.timestamp ? message.timestamp.toDate() : new Date();
      const formattedDate = messageDate.toLocaleDateString() + ' at ' + messageDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      messageDetailContent.innerHTML = `
        <div class="message-details">
          <div class="message-header">
            <div class="message-sender">From: ${message.senderName || 'Unknown Sender'}</div>
            <div class="message-time">${formattedDate}</div>
          </div>
          <h4>${message.subject || 'No Subject'}</h4>
          <p>${message.content || 'No content'}</p>
          <div class="message-actions">
            <button class="mark-read-btn" id="mark-message-read">
              <i class="fas fa-check"></i> ${message.read ? 'Mark as Unread' : 'Mark as Read'}
            </button>
            <button class="delete-btn" id="delete-message">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      `;
      
      // Add event listeners for message actions
      document.getElementById('mark-message-read').addEventListener('click', () => {
        toggleMessageReadStatus(messageId, !message.read);
      });
      
      document.getElementById('delete-message').addEventListener('click', () => {
        deleteMessage(messageId);
      });
      
      // Mark as read if not already read
      if (!message.read) {
        await toggleMessageReadStatus(messageId, true);
      }
      
      messageDetailPopup.style.display = 'block';
      overlay.style.display = 'block';
    }

    // Open notification detail popup
    async function openNotificationDetail(notificationId) {
      const notification = notifications.find(notif => notif.id === notificationId);
      
      if (!notification) {
        alert('Notification not found');
        return;
      }
      
      // Format date
      const notificationDate = notification.timestamp ? notification.timestamp.toDate() : new Date();
      const formattedDate = notificationDate.toLocaleDateString() + ' at ' + notificationDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      notificationDetailContent.innerHTML = `
        <div class="notification-details">
          <div class="notification-header">
            <div class="notification-title">${notification.title || 'Notification'}</div>
            <div class="notification-time">${formattedDate}</div>
          </div>
          <p>${notification.message || 'No content'}</p>
          <div class="notification-actions">
            <button class="mark-read-btn" id="mark-notification-read">
              <i class="fas fa-check"></i> ${notification.read ? 'Mark as Unread' : 'Mark as Read'}
            </button>
            <button class="delete-btn" id="delete-notification">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      `;
      
      // Add event listeners for notification actions
      document.getElementById('mark-notification-read').addEventListener('click', () => {
        toggleNotificationReadStatus(notificationId, !notification.read);
      });
      
      document.getElementById('delete-notification').addEventListener('click', () => {
        deleteNotification(notificationId);
      });
      
      // Mark as read if not already read
      if (!notification.read) {
        await toggleNotificationReadStatus(notificationId, true);
      }
      
      notificationDetailPopup.style.display = 'block';
      overlay.style.display = 'block';
    }

    // Toggle message read status
    async function toggleMessageReadStatus(messageId, readStatus) {
      try {
        await window.firebaseFunctions.updateDoc(
          window.firebaseFunctions.doc(window.firebaseDb, "messages", messageId),
          { read: readStatus }
        );
        
        // Reload messages to reflect the change
        await loadMessages();
        
        // If message detail is open, update it
        if (messageDetailPopup.style.display === 'block') {
          const currentMessage = messages.find(msg => msg.id === messageId);
          if (currentMessage) {
            openMessageDetail(messageId);
          }
        }
      } catch (error) {
        console.error("Error updating message status:", error);
        alert('Failed to update message status');
      }
    }

    // Toggle notification read status
    async function toggleNotificationReadStatus(notificationId, readStatus) {
      try {
        await window.firebaseFunctions.updateDoc(
          window.firebaseFunctions.doc(window.firebaseDb, "notifications", notificationId),
          { read: readStatus }
        );
        
        // Reload notifications to reflect the change
        await loadNotifications();
        
        // If notification detail is open, update it
        if (notificationDetailPopup.style.display === 'block') {
          const currentNotification = notifications.find(notif => notif.id === notificationId);
          if (currentNotification) {
            openNotificationDetail(notificationId);
          }
        }
      } catch (error) {
        console.error("Error updating notification status:", error);
        alert('Failed to update notification status');
      }
    }

    // Delete a message
    async function deleteMessage(messageId) {
      if (!confirm('Are you sure you want to delete this message?')) {
        return;
      }
      
      try {
        await window.firebaseFunctions.deleteDoc(
          window.firebaseFunctions.doc(window.firebaseDb, "messages", messageId)
        );
        
        // Reload messages to reflect the change
        await loadMessages();
        
        // Close the message detail popup
        closePopup(messageDetailPopup);
        
        alert('Message deleted successfully');
      } catch (error) {
        console.error("Error deleting message:", error);
        alert('Failed to delete message');
      }
    }

    // Delete a notification
    async function deleteNotification(notificationId) {
      if (!confirm('Are you sure you want to delete this notification?')) {
        return;
      }
      
      try {
        await window.firebaseFunctions.deleteDoc(
          window.firebaseFunctions.doc(window.firebaseDb, "notifications", notificationId)
        );
        
        // Reload notifications to reflect the change
        await loadNotifications();
        
        // Close the notification detail popup
        closePopup(notificationDetailPopup);
        
        alert('Notification deleted successfully');
      } catch (error) {
        console.error("Error deleting notification:", error);
        alert('Failed to delete notification');
      }
    }

    // Open material popup
    function openMaterialPopup(subject) {
      selectedSubjectForMaterial = subject;
      materialTitleInput.value = '';
      materialDescriptionInput.value = '';
      materialFileInput.value = '';
      fileNameDisplay.textContent = 'No file chosen';
      materialPopup.style.display = 'block';
      overlay.style.display = 'block';
    }

    // Updated saveMaterial function
    async function saveMaterial() {
      const title = materialTitleInput.value.trim();
      const description = materialDescriptionInput.value.trim();
      const file = materialFileInput.files[0];
      
      if (!title) {
        alert('Please enter a material title');
        return;
      }
      
      if (!file) {
        alert('Please select a file to upload');
        return;
      }
      
      try {
        saveMaterialBtn.disabled = true;
        saveMaterialBtn.innerHTML = '<div class="loading"></div> Uploading...';
        
        const metadata = {
          title: title,
          description: description,
          subject: selectedSubjectForMaterial
        };
        
        const result = await uploadStudyMaterial(file, metadata);
        
        closePopup(materialPopup);
        alert('Material uploaded successfully!');
        
        // Reset form
        materialTitleInput.value = '';
        materialDescriptionInput.value = '';
        materialFileInput.value = '';
        fileNameDisplay.textContent = 'No file chosen';
        
      } catch (error) {
        console.error("Error uploading material:", error);
        
        let errorMessage = 'Failed to upload material. ';
        if (error.message.includes('Invalid file type')) {
          errorMessage = error.message;
        } else if (error.message.includes('File size too large')) {
          errorMessage = error.message;
        } else if (error.code === 'storage/unauthorized') {
          errorMessage += 'Storage permission denied.';
        } else if (error.code === 'storage/unknown') {
          errorMessage += 'Unknown storage error.';
        } else if (error.code === 'storage/quota-exceeded') {
          errorMessage += 'Storage quota exceeded.';
        } else {
          errorMessage += 'Please try again. Error: ' + error.message;
        }
        
        alert(errorMessage);
      } finally {
        saveMaterialBtn.disabled = false;
        saveMaterialBtn.innerHTML = 'Upload';
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Mobile menu toggle
      menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('active');
      });

      // Logout button
      logoutBtn.addEventListener('click', async () => {
        try {
          await window.firebaseFunctions.signOut(window.firebaseAuth);
          window.location.href = 'index.html';
        } catch (error) {
          console.error("Error signing out:", error);
        }
      });

      // Refresh button
      refreshBtn.addEventListener('click', async () => {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<div class="loading"></div> Refreshing...';
        
        await loadDashboardData();
        
        setTimeout(() => {
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
        }, 1000);
      });

      // Popup controls
      popupCloseButtons.forEach(button => {
        button.addEventListener('click', () => {
          const popup = button.closest('.popup');
          closePopup(popup);
        });
      });

      overlay.addEventListener('click', () => {
        closeAllPopups();
      });

      cancelMaterialBtn.addEventListener('click', () => {
        closePopup(materialPopup);
      });

      saveMaterialBtn.addEventListener('click', saveMaterial);

      // File input display
      materialFileInput.addEventListener('change', () => {
        if (materialFileInput.files.length > 0) {
          fileNameDisplay.textContent = materialFileInput.files[0].name;
        } else {
          fileNameDisplay.textContent = 'No file chosen';
        }
      });

      // Mail and notification icons
      mailIcon.addEventListener('click', (e) => {
        e.preventDefault();
        messagesPopup.style.display = 'block';
        overlay.style.display = 'block';
      });

      notificationIcon.addEventListener('click', (e) => {
        e.preventDefault();
        notificationsPopup.style.display = 'block';
        overlay.style.display = 'block';
      });

      // Clear subject view button
      clearSubjectViewBtn.addEventListener('click', clearSubjectView);
    }

    // Close a specific popup
    function closePopup(popup) {
      popup.style.display = 'none';
      overlay.style.display = 'none';
    }

    // Close all popups
    function closeAllPopups() {
      const popups = document.querySelectorAll('.popup');
      popups.forEach(popup => {
        popup.style.display = 'none';
      });
      overlay.style.display = 'none';
    }
  </script>
</body>
</html>
