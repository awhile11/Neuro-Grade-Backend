<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NeuroGrade - Students</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged,
    signOut 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    query, 
    where, 
    getDocs,
    doc,
    getDoc,
    updateDoc,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB_jkCjYBpGzkwxtLmC6DKF7g0xxAAUPck",
    authDomain: "neuro-grade-aefa0.firebaseapp.com",
    projectId: "neuro-grade-aefa0",
    storageBucket: "neuro-grade-aefa0.firebasestorage.app",
    messagingSenderId: "301322876081",
    appId: "1:301322876081:web:c3fd4b8302da63462e5e90"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  console.log("Firebase initialized successfully");
  
  // Make Firebase objects globally available
  window.firebaseAuth = auth;
  window.firebaseDb = db;
  window.firebaseFunctions = {
    onAuthStateChanged,
    signOut,
    collection,
    query,
    where,
    getDocs,
    doc,
    getDoc,
    updateDoc,
    orderBy
  };
</script>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  body {
    display: flex;
    background: #f8f9fa;
    height: 100vh;
    color: #333;
    overflow: hidden;
  }

  /* Loading screen */
  .loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #8e44ad;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    color: white;
  }

  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 20px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Top left logo */
  .top-left-logo {
    position: absolute;
    top: -35px;
    left: -10px;
    height: 200px;
    z-index: 1000;
  }

  /* Sidebar */
   .sidebar {
  width: 200px;
  height: 100vh;
  background: #fff;
  padding: 20px;
  border-right: 1px solid #ddd;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: center;
  box-shadow: 2px 0 8px rgba(0,0,0,0.08);
  border-radius: 0 12px 12px 0;
  transition: all 0.3s ease;
}
  .nav {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
  }

  .nav a {
    text-decoration: none;
    width: 100%;
  }

  .nav button {
    background: none;
    border: 1px solid rgba(0,0,0,0.08);
    font-size: 16px;
    padding: 12px 15px;
    text-align: left;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s ease;
    color: #333;
    width: 100%;
    display: flex;
    align-items: center;
    gap: 15px;
    position: relative;
    overflow: hidden;
  }

  .nav button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(142, 68, 173, 0.1), transparent);
    transition: left 0.5s ease;
  }

  .nav button:hover::before {
    left: 100%;
  }

  .nav button.active {
    background: #8e44ad;
    color: #fff;
    font-weight: bold;
    border-color: #6c3483;
    transform: translateX(5px);
    box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
  }

  .nav button:hover {
    background: #f0e6f5;
    color: #8e44ad;
    border-color: #8e44ad;
    transform: translateX(3px);
  }

  .nav button i {
    transition: transform 0.3s ease;
  }

  .nav button:hover i {
    transform: scale(1.2);
  }

  .nav button.active i {
    transform: scale(1.2);
    color: #fff;
  }

  /* Main content */
  .main {
    flex: 1;
    padding: 20px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    margin-top: 70px;
    background: #f8f9fa;
    transition: all 0.3s ease;
  }

  /* Top bar */
  .top-bar {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.05);
  }

  .icon-link {
    position: relative;
    text-decoration: none;
    color: #8e44ad;
    font-size: 20px;
    transition: transform 0.3s, color 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #f0e6f5;
    margin-top: -10px;
    border: 1px solid rgba(142, 68, 173, 0.2);
  }

  .icon-link:hover {
    transform: scale(1.2) rotate(5deg);
    color: #ff6b6b;
    background: #ffe9e9;
    border-color: rgba(255, 107, 107, 0.3);
  }

  .icon-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff6b6b;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    border: 1px solid #fff;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  .top-user {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    padding: 8px 15px;
    background: #f8f9fa;
    border-radius: 20px;
    border: 1px solid rgba(0,0,0,0.08);
    transition: all 0.3s ease;
  }

  .top-user:hover {
    background: #f0e6f5;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .top-user img {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    object-fit: cover;
    transition: all 0.3s ease;
  }

  .top-user:hover img {
    transform: scale(1.1);
    border: 2px solid #8e44ad;
  }

  /* Layout */
  .students-layout {
    display: flex;
    gap: 20px;
    flex: 1;
  }

  /* Student list */
  .student-list {
    width: 250px;
    background: #fff;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    gap: 10px;
    border: 1px solid rgba(0,0,0,0.08);
    transition: all 0.3s ease;
  }

  .student-list:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }

  .student-list input {
    width: 100%;
    padding: 10px;
    font-size: 13px;
    border: 1px solid #ddd;
    border-radius: 6px;
    transition: all 0.3s;
    background: #f8f9fa;
  }

  .student-list input:focus {
    outline: none;
    border-color: #8e44ad;
    box-shadow: 0 0 8px rgba(142, 68, 173, 0.4);
    background: #fff;
  }

  .students {
    flex: 1;
    margin-top: 10px;
    overflow-y: auto;
    max-height: 400px;
    padding: 5px;
    border: 1px solid rgba(0,0,0,0.05);
    border-radius: 8px;
    background: #f8f9fa;
  }

  .student-item {
    padding: 8px 10px;
    font-size: 14px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s;
    border: 1px solid transparent;
    background: #fff;
    margin-bottom: 5px;
    position: relative;
    overflow: hidden;
  }

  .student-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(142, 68, 173, 0.1), transparent);
    transition: left 0.5s ease;
  }

  .student-item:hover::before {
    left: 100%;
  }

  .student-item:hover {
    background: #f0e6f5;
    color: #8e44ad;
    border-color: #8e44ad;
    transform: translateX(3px);
  }

  .student-item.active {
    background: #8e44ad;
    color: white;
    border-color: #6c3483;
    transform: translateX(5px);
    box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
  }

  /* Right panel */
  .student-details {
    flex: 1;
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    border: 1px solid rgba(0,0,0,0.08);
    transition: all 0.3s ease;
  }

  .student-details:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }

  .tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
  }

  .tabs button {
    border: 1px solid #ddd;
    background: #f8f9fa;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .tabs button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(142, 68, 173, 0.1), transparent);
    transition: left 0.5s ease;
  }

  .tabs button:hover::before {
    left: 100%;
  }

  .tabs button.active {
    background: #8e44ad;
    color: white;
    font-weight: bold;
    border-color: #6c3483;
    transform: translateY(-2px);
    box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
  }

  .tabs button:hover {
    background: #f0e6f5;
    color: #8e44ad;
    border-color: #8e44ad;
    transform: translateY(-2px);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #e9ecef;
  }

  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
    font-size: 14px;
  }

  th {
    background: #8e44ad;
    color: white;
    font-weight: bold;
  }

  tr {
    transition: all 0.3s ease;
  }

  tr:hover {
    background: #f9f2fc;
    transform: translateX(3px);
  }

  /* Status badges */
  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .status-badge:hover {
    transform: scale(1.1);
  }
  
  .status-completed {
    background-color: #e8f5e9;
    color: #2e7d32;
  }
  
  .status-pending {
    background-color: #ffecb3;
    color: #f57c00;
  }
  
  .status-missing {
    background-color: #ffcdd2;
    color: #c62828;
  }

  .status-late {
    background-color: #ffcdd2;
    color: #c62828;
  }
  
  .status-ontime {
    background-color: #e8f5e9;
    color: #2e7d32;
  }
  
  .status-taken {
    background-color: #e8f5e9;
    color: #2e7d32;
  }
  
  .status-not-taken {
    background-color: #ffcdd2;
    color: #c62828;
  }

  /* Loading indicator */
  .loading {
    text-align: center;
    padding: 20px;
    color: #8e44ad;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
  }

  .loading i {
    font-size: 24px;
    margin-bottom: 10px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
   0% { transform: rotate(0deg); }
   100% { transform: rotate(360deg); }
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 30px;
    color: #888;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
  }

  .empty-state:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }

  .empty-state i {
    font-size: 40px;
    margin-bottom: 10px;
    color: #ddd;
    transition: all 0.3s ease;
  }

  .empty-state:hover i {
    color: #8e44ad;
    transform: scale(1.2);
  }

  /* Logout button */
  .logout-btn {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    margin-top: 20px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    box-shadow: 0 2px 6px rgba(255, 107, 107, 0.3);
  }

  .logout-btn:hover {
    background: #ff5252;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(255, 107, 107, 0.4);
  }

  /* Menu toggle for mobile (hidden by default) */
  .menu-toggle {
    display: none;
    position: fixed;
    top: 20px;
    right: 20px;
    background: #8e44ad;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 24px;
    cursor: pointer;
    z-index: 1001;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  .menu-toggle:hover {
    background: #793a9c;
    transform: rotate(90deg);
  }

  /* Test title link */
  .test-title {
    color: #8e44ad;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 4px 8px;
    border-radius: 4px;
  }

  .test-title:hover {
    background: #f0e6f5;
    text-decoration: underline;
  }

  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1002;
    justify-content: center;
    align-items: center;
  }
  
  .modal-content {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 900px;
    max-height: 80vh;
    overflow: auto;
    padding: 0;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    position: relative;
    border: 1px solid #e9ecef;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 16px 16px 0 0;
  }
  
  .modal-header h3 {
    color: #8e44ad;
    font-size: 20px;
    font-weight: 600;
    margin: 0;
  }
  
  .close-modal {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #888;
    transition: all 0.3s ease;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .close-modal:hover {
    background: #f0e6f5;
    color: #8e44ad;
  }
  
  .modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
  }
  
  .question-item {
    margin-bottom: 25px;
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    background: #f8f9fa;
  }
  
  .question-text {
    font-weight: 600;
    margin-bottom: 10px;
    color: #333;
    font-size: 16px;
  }
  
  .question-points {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
  }
  
  .student-answer {
    background: white;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid #ddd;
    margin-bottom: 15px;
    font-size: 14px;
    line-height: 1.5;
  }
  
  .grade-input {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
  }
  
  .grade-input label {
    font-weight: 500;
    color: #555;
  }
  
  .grade-input input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    width: 80px;
    font-size: 14px;
  }
  
  .grade-input input:focus {
    outline: none;
    border-color: #8e44ad;
    box-shadow: 0 0 0 2px rgba(142, 68, 173, 0.2);
  }
  
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    padding: 20px;
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 0 0 16px 16px;
    gap: 10px;
  }
  
  .btn-primary {
    background: #8e44ad;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .btn-primary:hover {
    background: #793a9c;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  .btn-secondary {
    background: #888;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .btn-secondary:hover {
    background: #666;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  /* Test info section */
  .test-info {
    margin-bottom: 20px;
    padding: 15px;
    background: #f0e6f5;
    border-radius: 8px;
    border-left: 4px solid #8e44ad;
  }
  
  .test-info p {
    margin: 5px 0;
    font-size: 14px;
  }

  /* Responsive design */
  @media (max-width: 992px) {
    .sidebar {
      position: fixed;
      left: -250px;
      height: 100%;
      z-index: 1000;
      margin-top: 0;
      border-radius: 0;
      transition: left 0.3s ease;
    }
    
    .sidebar.active {
      left: 0;
    }
    
    .main {
      margin-left: 0;
      margin-top: 20px;
    }
    
    .menu-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .students-layout {
      flex-direction: column;
    }
    
    .student-list {
      width: 100%;
    }
    
    .top-left-logo {
      top: 10px;
      left: 10px;
      height: 120px;
    }
  }

  @media (max-width: 576px) {
    .top-bar {
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .top-user {
      order: -1;
      width: 100%;
      justify-content: center;
      margin-bottom: 10px;
    }
    
    .modal-content {
      width: 95%;
    }
    
    .grade-input {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
</head>
<body>
  <!-- Loading screen -->
  <div class="loading-screen" id="loading-screen">
    <div class="loading-spinner"></div>
    <h2>Loading NeuroGrade</h2>
    <p>Please wait while we load your data...</p>
  </div>

  <!-- Top left logo -->
  <img src="neuro grade logo.jpg" alt="NeuroGrade Logo" class="top-left-logo">

  <!-- Mobile menu toggle -->
  <button class="menu-toggle" id="menu-toggle">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="nav">
      <button onclick="window.location.href='teacher-dashboard.html'">
        <i class="fas fa-home"></i> Home
      </button>
      <button onclick="window.location.href='task.html'">
        <i class="fas fa-task"></i> Tasks
      </button>
      <button class="active">
        <i class="fas fa-users"></i> Students
      </button>
      <button onclick="window.location.href='practice.html'">
        <i class="fas fa-graduation-cap"></i> Practice
      </button>
      <button onclick="window.location.href='feedback.html'">
        <i class="fas fa-comment-dots"></i> Feedback
      </button>
    </div>
    <button class="logout-btn" id="logout-btn">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </div>

  <!-- Main -->
  <div class="main">
    <!-- Top bar -->
    <div class="top-bar">
      <a href="#" class="icon-link" id="mail-icon">
        <i class="fas fa-envelope"></i>
        <span class="icon-badge" id="mail-badge">0</span>
      </a>
      <a href="#" class="icon-link" id="notification-icon">
        <i class="fas fa-bell"></i>
        <span class="icon-badge" id="notification-badge">0</span>
      </a>
      <div class="top-user" id="user-info">
        <span><b id="user-name">Loading...</b><br><small id="user-email">Loading...</small></span>
        <img src="https://placehold.co/35x35/8e44ad/FFFFFF?text=?" alt="User" id="user-avatar">
      </div>
    </div>

    <!-- Students Page -->
    <div id="students">
      <div class="students-layout">
        <!-- Left: Student list -->
        <div class="student-list">
          <input type="text" placeholder="Student number" id="studentNumberSearch">
          <input type="text" placeholder="Name" id="studentNameSearch">

          <div class="students" id="studentList">
            <!-- Student list will be populated from database -->
            <div class="loading">
              <i class="fas fa-spinner"></i>
              <p>Loading students from database...</p>
            </div>
          </div>
        </div>

        <!-- Right: Tests -->
        <div class="student-details">
          <div class="tabs">
            <button class="tab-btn active" data-tab="tests">Tests</button>
          </div>

          <!-- Tab content -->
          <div id="tests" class="tab-content">
            <div class="empty-state">
              <i class="fas fa-file-alt"></i>
              <p>Select a student to view tests</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Details Modal -->
  <div class="modal" id="testDetailsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTestTitle">Test Details</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body" id="modalTestBody">
        <!-- Test questions and answers will be populated here -->
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="closeModalBtn">Close</button>
        <button class="btn-primary" id="saveGradesBtn">Save Grades</button>
      </div>
    </div>
  </div>

<script>
  // Global variables
  let currentUser = null;
  let currentTeacher = null;
  let teacherStudents = [];
  let currentTestData = null;
  let currentTestId = null;
  let currentTestType = null;
  let originalTestData = null;

  // Initialize the dashboard
  document.addEventListener('DOMContentLoaded', function() {
    initializeAuth();
    setupEventListeners();
  });

  // Initialize Firebase authentication
  function initializeAuth() {
    window.firebaseFunctions.onAuthStateChanged(window.firebaseAuth, async (user) => {
      if (user) {
        currentUser = user;
        await loadTeacherData(user.uid);
        // Hide loading screen after data is loaded
        setTimeout(() => {
          document.getElementById('loading-screen').style.display = 'none';
        }, 1000);
      } else {
        // Redirect to login page if not authenticated
        window.location.href = 'index.html';
      }
    });
  }

  // Load teacher data from Firestore
  async function loadTeacherData(uid) {
    try {
      const teacherDoc = await window.firebaseFunctions.getDoc(
        window.firebaseFunctions.doc(window.firebaseDb, "teachers", uid)
      );
      
      if (teacherDoc.exists()) {
        currentTeacher = teacherDoc.data();
        updateUserInterface();
        await loadStudentsFromDatabase();
      } else {
        console.error("Teacher data not found");
      }
    } catch (error) {
      console.error("Error loading teacher data:", error);
    }
  }

  // Update UI with teacher data
  function updateUserInterface() {
    if (currentTeacher) {
      document.getElementById('user-name').textContent = `${currentTeacher.firstName} ${currentTeacher.lastName}`;
      document.getElementById('user-email').textContent = currentTeacher.email;
      document.getElementById('user-avatar').src = `https://placehold.co/35x35/8e44ad/FFFFFF?text=${currentTeacher.firstName.charAt(0)}${currentTeacher.lastName.charAt(0)}`;
    }
  }

  // Function to load students from database
  async function loadStudentsFromDatabase() {
    const studentList = document.getElementById("studentList");
    studentList.innerHTML = `
      <div class="loading">
        <i class="fas fa-spinner"></i>
        <p>Loading students from database...</p>
      </div>
    `;
    
    try {
      if (!currentTeacher) return;
      
      const teacherFullName = `${currentTeacher.firstName} ${currentTeacher.lastName}`;
      
      const studentsQuery = window.firebaseFunctions.query(
        window.firebaseFunctions.collection(window.firebaseDb, "students"),
        window.firebaseFunctions.where("teacherName", "==", teacherFullName)
      );
      
      const querySnapshot = await window.firebaseFunctions.getDocs(studentsQuery);
      teacherStudents = [];
      
      querySnapshot.forEach((doc) => {
        teacherStudents.push({ id: doc.id, ...doc.data() });
      });
      
      renderStudents(teacherStudents);
    } catch (error) {
      console.error("Error loading students:", error);
      studentList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Error loading students</p>
        </div>
      `;
    }
  }

  // Render students in the UI
  function renderStudents(students) {
    const studentList = document.getElementById("studentList");
    
    if (students.length === 0) {
      studentList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-users"></i>
          <p>No students registered under your name yet</p>
          <p>Students who register with your name will appear here</p>
        </div>
      `;
      return;
    }
    
    let studentsHTML = "";
    students.forEach((student, index) => {
      studentsHTML += `
        <div class="student-item ${index === 0 ? 'active' : ''}" 
             data-student-id="${student.id}">
          ${student.firstName} ${student.lastName} <span>${student.studentNumber}</span>
        </div>
      `;
    });
    
    studentList.innerHTML = studentsHTML;
    
    // Add event listeners to student items
    document.querySelectorAll(".student-item").forEach(stu => {
      stu.addEventListener("click", function() {
        document.querySelectorAll(".student-item").forEach(s => s.classList.remove("active"));
        this.classList.add("active");
        
        // Load data for the selected student
        const studentId = this.dataset.studentId;
        loadTestsData(studentId);
      });
    });
    
    // Load data for first student by default
    if (students.length > 0) {
      const firstStudent = document.querySelector(".student-item.active");
      if (firstStudent) {
        loadTestsData(firstStudent.dataset.studentId);
      }
    }
  }

  // Load tests data from database
  async function loadTestsData(studentId) {
    const contentDiv = document.getElementById('tests');
    
    // Show loading state
    contentDiv.innerHTML = `
      <div class="loading">
        <i class="fas fa-spinner"></i>
        <p>Loading tests from database...</p>
      </div>
    `;
    
    try {
      // Get student document
      const studentDoc = await window.firebaseFunctions.getDoc(
        window.firebaseFunctions.doc(window.firebaseDb, "students", studentId)
      );
      
      if (!studentDoc.exists()) {
        throw new Error("Student not found");
      }
      
      const studentData = studentDoc.data();
      
      // Get test submissions for this student
      const testSubmissionsQuery = window.firebaseFunctions.query(
        window.firebaseFunctions.collection(window.firebaseDb, "testSubmissions"),
        window.firebaseFunctions.where("studentId", "==", studentId)
      );
      
      const testSubmissionsSnapshot = await window.firebaseFunctions.getDocs(testSubmissionsQuery);
      const testSubmissions = [];
      
      testSubmissionsSnapshot.forEach(doc => {
        testSubmissions.push({ id: doc.id, ...doc.data() });
      });
      
      // Get manual test submissions for this student
      const manualTestSubmissionsQuery = window.firebaseFunctions.query(
        window.firebaseFunctions.collection(window.firebaseDb, "manual test submissions"),
        window.firebaseFunctions.where("studentId", "==", studentId)
      );
      
      const manualTestSubmissionsSnapshot = await window.firebaseFunctions.getDocs(manualTestSubmissionsQuery);
      const manualTestSubmissions = [];
      
      manualTestSubmissionsSnapshot.forEach(doc => {
        manualTestSubmissions.push({ id: doc.id, ...doc.data() });
      });
      
      // Combine both test submission types
      const allTestSubmissions = [...testSubmissions, ...manualTestSubmissions];
      
      if (allTestSubmissions.length === 0) {
        contentDiv.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-file-alt"></i>
            <p>No tests found for this student</p>
            <p>Tests will appear here when created</p>
          </div>
        `;
        return;
      }
      
      // Create tests table
      let tableHTML = `
        <table>
          <thead>
            <tr>
              <th>Test Name</th>
              <th>Date</th>
              <th>Status</th>
              <th>AI Grade</th>
              <th>Updated Grade</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      for (const test of allTestSubmissions) {
        const testDate = test.submittedAt ? test.submittedAt.toDate().toLocaleDateString() : 
                         test.createdAt ? test.createdAt.toDate().toLocaleDateString() : 'N/A';
        
        // Determine status
        const status = test.submittedAt ? 'Taken' : 'Not Taken';
        const statusClass = test.submittedAt ? 'status-taken' : 'status-not-taken';
        
        const aiGrade = test.aiGrade ? `${test.aiGrade}%` : 'N/A';
        const updatedGrade = test.updatedGrade ? `${test.updatedGrade}%` : 'N/A';
        
        // Get test title from original test if available
        let testTitle = test.testName || test.name || 'Unnamed Test';
        let testType = test.testId ? 'testSubmissions' : 'manual test submissions';
        
        // Try to get the original test document to get the title
        if (test.testId) {
          try {
            const originalTestDoc = await window.firebaseFunctions.getDoc(
              window.firebaseFunctions.doc(window.firebaseDb, "tests", test.testId)
            );
            if (originalTestDoc.exists()) {
              const originalTestData = originalTestDoc.data();
              testTitle = originalTestData.title || originalTestData.name || testTitle;
            }
          } catch (error) {
            console.error("Error fetching original test data:", error);
          }
        }
        
        tableHTML += `
          <tr>
            <td>
              <a class="test-title" data-test-id="${test.id}" data-test-type="${testType}">
                ${testTitle}
              </a>
            </td>
            <td>${testDate}</td>
            <td><span class="status-badge ${statusClass}">${status}</span></td>
            <td>${aiGrade}</td>
            <td>${updatedGrade}</td>
          </tr>
        `;
      }
      
      tableHTML += `</tbody></table>`;
      contentDiv.innerHTML = tableHTML;
      
      // Add event listeners to test titles
      document.querySelectorAll(".test-title").forEach(title => {
        title.addEventListener("click", async function() {
          const testId = this.dataset.testId;
          const testType = this.dataset.testType;
          await showTestDetails(testId, testType);
        });
      });
    } catch (error) {
      console.error("Error loading tests:", error);
      contentDiv.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Error loading tests data</p>
        </div>
      `;
    }
  }

  // Show test details in modal
  async function showTestDetails(testId, testType) {
    const modal = document.getElementById('testDetailsModal');
    const modalTitle = document.getElementById('modalTestTitle');
    const modalBody = document.getElementById('modalTestBody');
    
    // Show loading state
    modalBody.innerHTML = `
      <div class="loading">
        <i class="fas fa-spinner"></i>
        <p>Loading test details...</p>
      </div>
    `;
    
    modal.style.display = 'flex';
    currentTestId = testId;
    currentTestType = testType;
    
    try {
      // Get test submission document
      const testDoc = await window.firebaseFunctions.getDoc(
        window.firebaseFunctions.doc(window.firebaseDb, testType, testId)
      );
      
      if (!testDoc.exists()) {
        throw new Error("Test not found");
      }
      
      currentTestData = testDoc.data();
      
      // Get original test data from "tests" collection
      let testTitle = currentTestData.testName || currentTestData.name || 'Test Details';
      let questions = [];
      
      if (currentTestData.testId) {
        try {
          const originalTestDoc = await window.firebaseFunctions.getDoc(
            window.firebaseFunctions.doc(window.firebaseDb, "tests", currentTestData.testId)
          );
          if (originalTestDoc.exists()) {
            originalTestData = originalTestDoc.data();
            testTitle = originalTestData.title || originalTestData.name || testTitle;
            questions = originalTestData.questions || [];
          }
        } catch (error) {
          console.error("Error fetching original test data:", error);
        }
      }
      
      // If no questions from original test, try to get from submission
      if (questions.length === 0) {
        questions = currentTestData.questions || [];
      }
      
      modalTitle.textContent = testTitle;
      
      // Display test information
      const testInfoHTML = `
        <div class="test-info">
          <p><strong>Student:</strong> ${currentTestData.studentName || 'Unknown Student'}</p>
          <p><strong>Submitted:</strong> ${currentTestData.submittedAt ? currentTestData.submittedAt.toDate().toLocaleString() : 'Not submitted'}</p>
          <p><strong>Current Grade:</strong> ${currentTestData.updatedGrade || currentTestData.aiGrade || 'Not graded'}%</p>
        </div>
      `;
      
      // Display questions and answers
      let questionsHTML = '';
      
      if (questions.length > 0) {
        questions.forEach((question, index) => {
          // Get student answer
          let studentAnswer = 'No answer provided';
          if (currentTestData.answers && currentTestData.answers[index] !== undefined) {
            studentAnswer = currentTestData.answers[index];
          } else if (currentTestData.answer && index === 0) {
            // For single question tests
            studentAnswer = currentTestData.answer;
          }
          
          // Get current grade for this question
          const currentGrade = currentTestData.questionGrades ? currentTestData.questionGrades[index] : '';
          const questionPoints = question.points || 10;
          
          questionsHTML += `
            <div class="question-item">
              <div class="question-text">Question ${index + 1}: ${question.text || question.question || question}</div>
              <div class="question-points">Points: ${questionPoints}</div>
              <div class="student-answer">
                <strong>Student Answer:</strong><br>
                ${studentAnswer}
              </div>
              <div class="grade-input">
                <label for="grade-${index}">Grade (points):</label>
                <input type="number" id="grade-${index}" value="${currentGrade}" min="0" max="${questionPoints}" step="0.5">
                <span> / ${questionPoints}</span>
              </div>
            </div>
          `;
        });
      } else {
        questionsHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-circle"></i>
            <p>No questions found in this test</p>
          </div>
        `;
      }
      
      modalBody.innerHTML = testInfoHTML + questionsHTML;
    } catch (error) {
      console.error("Error loading test details:", error);
      modalBody.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Error loading test details</p>
        </div>
      `;
    }
  }

  // Save grades to database
  async function saveGrades() {
    if (!currentTestId || !currentTestData || !currentTestType) return;
    
    try {
      const questionGrades = [];
      let totalGrade = 0;
      let maxPoints = 0;
      
      // Collect grades from inputs
      document.querySelectorAll('.grade-input input').forEach((input, index) => {
        const grade = parseFloat(input.value) || 0;
        questionGrades.push(grade);
        totalGrade += grade;
        
        // Calculate max points from original test questions
        if (originalTestData && originalTestData.questions && originalTestData.questions[index]) {
          maxPoints += originalTestData.questions[index].points || 10;
        } else if (currentTestData.questions && currentTestData.questions[index]) {
          maxPoints += currentTestData.questions[index].points || 10;
        } else {
          maxPoints += 10;
        }
      });
      
      // Calculate percentage
      const percentage = maxPoints > 0 ? Math.round((totalGrade / maxPoints) * 100) : 0;
      
      // Update the test document
      const testRef = window.firebaseFunctions.doc(window.firebaseDb, currentTestType, currentTestId);
      
      await window.firebaseFunctions.updateDoc(testRef, {
        questionGrades: questionGrades,
        updatedGrade: percentage,
        lastGradedBy: currentUser.uid,
        gradedAt: new Date()
      });
      
      // Close modal and refresh test data
      closeModal();
      
      // Refresh the tests table to show updated grades
      const activeStudent = document.querySelector(".student-item.active");
      if (activeStudent) {
        loadTestsData(activeStudent.dataset.studentId);
      }
      
      alert('Grades saved successfully!');
    } catch (error) {
      console.error("Error saving grades:", error);
      alert('Error saving grades. Please try again.');
    }
  }

  // Close modal
  function closeModal() {
    const modal = document.getElementById('testDetailsModal');
    modal.style.display = 'none';
    currentTestData = null;
    currentTestId = null;
    currentTestType = null;
    originalTestData = null;
  }

  // Search functionality
  function filterStudents() {
    const numberSearch = document.getElementById("studentNumberSearch").value.toLowerCase();
    const nameSearch = document.getElementById("studentNameSearch").value.toLowerCase();
    
    document.querySelectorAll(".student-item").forEach(student => {
      const studentNumber = student.querySelector("span").textContent.toLowerCase();
      const studentName = student.textContent.toLowerCase();
      
      const numberMatch = studentNumber.includes(numberSearch);
      const nameMatch = studentName.includes(nameSearch);
      
      student.style.display = (numberMatch && nameMatch) ? "flex" : "none";
    });
  }

  // Setup event listeners
  function setupEventListeners() {
    // Search functionality
    document.getElementById("studentNumberSearch").addEventListener("input", filterStudents);
    document.getElementById("studentNameSearch").addEventListener("input", filterStudents);
    
    // Mobile menu toggle
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    
    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('active');
    });
    
    // Logout button
    document.getElementById('logout-btn').addEventListener('click', async () => {
      try {
        await window.firebaseFunctions.signOut(window.firebaseAuth);
        window.location.href = 'index.html';
      } catch (error) {
        console.error("Error signing out:", error);
      }
    });
    
    // Sidebar navigation
    document.querySelectorAll(".nav button").forEach(button => {
      button.addEventListener("click", function() {
        document.querySelectorAll(".nav button").forEach(btn => btn.classList.remove("active"));
        this.classList.add("active");
      });
    });
    
    // Modal event listeners
    document.querySelector('.close-modal').addEventListener('click', closeModal);
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    document.getElementById('saveGradesBtn').addEventListener('click', saveGrades);
    
    // Close modal when clicking outside
    document.getElementById('testDetailsModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
      }
    });
  }
</script>
</body>
</html>
